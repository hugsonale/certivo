<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certivo Prime Verification</title>
<style>
body { font-family: Arial; background: #0f172a; color: #e5e7eb; text-align:center; padding:20px; }
video { width: 320px; border-radius: 12px; margin-top: 10px; }
button { margin-top:15px; padding:10px 22px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; background:#3b82f6; color:#fff; }
button:disabled { background:#64748b; cursor:not-allowed; }
#status,#faceStatus,#challengeProgress,#challengeTimer,#fastTrackLabel{margin-top:15px; font-weight:bold;}
#fastTrackLabel{display:none; color:#facc15;}
#verdictScreen{display:none;margin-top:25px;}
#trustBarOuter{width:320px;margin:0 auto;background:#1e293b;border-radius:12px;overflow:hidden;}
#trustBar{height:18px;width:0%;transition: width 0.8s ease;}
</style>
</head>
<body>

<h1>Certivo Prime Verification</h1>

<div id="cameraContainer">
    <video id="video" autoplay muted></video>
</div>

<!-- STAGE 0 -->
<button id="startFaceBtn">Start Face Verification</button>

<!-- STAGE 1 -->
<div id="faceSection" style="display:none;">
    <p id="faceStatus">üì∑ Preparing...</p>
    <br>
    <button id="proceedBtn" disabled>Proceed to Challenge</button>
</div>

<!-- STAGE 2 -->
<div id="challengeSection" style="display:none;">
    <p id="fastTrackLabel">‚ö° Fast-Track Mode</p>
    <p id="challengeProgress"></p>
    <p id="status"></p>
    <p id="challengeTimer"></p>
</div>

<!-- FINAL VERDICT -->
<div id="verdictScreen">
    <h2>‚úÖ HUMAN VERIFIED</h2>
    <p>Trust Confidence</p>
    <div id="trustBarOuter"><div id="trustBar"></div></div>
    <p id="trustLabel" style="margin-top:10px;font-weight:bold;"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh"></script>

<script>
const startFaceBtn = document.getElementById("startFaceBtn");
const faceSection = document.getElementById("faceSection");
const challengeSection = document.getElementById("challengeSection");
const proceedBtn = document.getElementById("proceedBtn");
const video = document.getElementById("video");
const faceStatus = document.getElementById("faceStatus");
const statusEl = document.getElementById("status");
const challengeProgress = document.getElementById("challengeProgress");
const challengeTimer = document.getElementById("challengeTimer");
const fastTrackLabel = document.getElementById("fastTrackLabel");

let faceModel;
let challenges=[], challengeIndex=0, sessionResults=[], countdownInterval=null;
let deviceId = "device_" + Math.floor(Math.random()*100000);
let userAgent = navigator.userAgent;

async function initCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
}

async function verifyFace() {
    faceStatus.innerText = "üì∑ Capturing face for server verification...";
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
    const blob = await new Promise(resolve => canvas.toBlob(resolve,"image/jpeg"));
    const formData = new FormData();
    formData.append("face_image", blob);
    formData.append("device_id", deviceId);

    const res = await fetch("http://127.0.0.1:8000/v1/face_verify", {method:"POST",body:formData});
    const data = await res.json();
    return data.verified;
}

startFaceBtn.onclick = async () => {
    startFaceBtn.style.display = "none";
    faceSection.style.display = "block";
    await initCamera();
    faceModel = await facemesh.load();

    faceStatus.innerText = "üì∑ Detecting face locally...";
    const interval = setInterval(async ()=>{
        const preds = await faceModel.estimateFaces(video);
        if(preds.length===1){
            clearInterval(interval);
            faceStatus.innerText = "üì° Sending to server...";
            const verified = await verifyFace();
            if(verified){
                faceStatus.innerText="‚úÖ Face verified by server";
                proceedBtn.disabled=false;
            } else{
                faceStatus.innerText="‚ùå Face not verified by server. Retry.";
            }
        }
    },400);
};

proceedBtn.onclick = async () => {
    faceSection.style.display="none";
    challengeSection.style.display="block";
    statusEl.innerText="‚è≥ Loading challenges...";
    await loadChallenges();
};

async function loadChallenges(){
    const res = await fetch(`http://127.0.0.1:8000/v1/challenge?device_id=${deviceId}`);
    const data = await res.json();
    if(!Array.isArray(data.challenges)||data.challenges.length===0){
        statusEl.innerText="‚ùå No challenges";
        return;
    }
    challenges = data.challenges.map(ch=>({...ch, token: ch.id+"_"+Math.floor(Math.random()*1000000)}));
    challengeIndex=0; sessionResults=[];
    loadNextChallenge();
}

function loadNextChallenge(){
    clearInterval(countdownInterval);
    if(challengeIndex>=challenges.length){finalizeSession();return;}
    const ch=challenges[challengeIndex]; challengeIndex++;
    challengeProgress.innerText=`Challenge ${challengeIndex} of ${challenges.length}`;
    statusEl.innerText="üß† "+ch.instruction;
    fastTrackLabel.style.display = ch.fast_track?"block":"none";
    const duration = ch.fast_track?10:15;
    startRecording(ch.id, ch.token, duration);
}

// Recording, countdown, submission (only snippet for token)
async function submitRecording(challengeId, challengeToken){
    const blob = new Blob(recordedChunks,{type:"video/webm"});
    const formData = new FormData();
    formData.append("video",blob);
    formData.append("challenge_id",challengeId);
    formData.append("challenge_token",challengeToken);
    formData.append("device_id",deviceId);

    try{
        const res = await fetch("http://127.0.0.1:8000/v1/verify",{method:"POST",body:formData});
        const result = await res.json();
        sessionResults.push(result);
        if(result.challenge_passed){statusEl.innerText="‚úÖ Challenge passed"; setTimeout(loadNextChallenge,600);}
        else{statusEl.innerText="‚ùå Challenge failed"; setTimeout(()=>{challengeIndex--; loadNextChallenge();},800);}
    }catch(err){console.error(err); statusEl.innerText="‚ùå Verification error";}
}

async function finalizeSession(){
    statusEl.innerText="üîê Calculating trust score...";
    const res=await fetch("http://127.0.0.1:8000/v1/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:sessionResults,device_id:deviceId,user_agent:userAgent})});
    const final=await res.json();
    document.getElementById("verdictScreen").style.display="block";
    const bar=document.getElementById("trustBar"), label=document.getElementById("trustLabel");
    bar.style.width=final.trust_score+"%";
    bar.style.background=final.trust_level==="high"?"#22c55e":final.trust_level==="medium"?"#facc15":"#ef4444";
    label.innerText=`${final.trust_level.toUpperCase()} TRUST (${final.trust_score}%)`;
}
</script>
</body>
</html>
