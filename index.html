<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Certivo â€“ Human Verification</title>
<style>
    body { font-family: Arial, sans-serif; background: #0e0e11; color: #fff; text-align: center; }
    video { width: 420px; border-radius: 8px; margin-top: 10px; }
    button { padding: 12px 18px; font-size: 16px; margin-top: 12px; cursor: pointer; }
    #status { margin-top: 14px; font-weight: bold; }
</style>
</head>
<body>

<h2>Certivo Human Verification</h2>

<button id="startBtn">Start Verification</button>

<div id="status">Idle</div>

<video id="video" autoplay muted></video>

<script>
const video = document.getElementById("video");
const startBtn = document.getElementById("startBtn");
const statusEl = document.getElementById("status");

let mediaRecorder;
let recordedChunks = [];
let challengeQueue = [];
let currentChallenge = null;
let challengeShownAt = null;

/* ------------------ LOAD CHALLENGE ------------------ */
async function loadChallenge() {
    if (challengeQueue.length === 0) {
        statusEl.innerText = "Loading challenges...";
        const res = await fetch("http://127.0.0.1:8000/v1/challenge");

        if (!res.ok) {
            statusEl.innerText = "âŒ Failed to load challenges";
            return;
        }

        const data = await res.json();

        if (!data.challenges || data.challenges.length === 0) {
            statusEl.innerText = "âŒ No challenges returned";
            return;
        }

        challengeQueue = data.challenges;
    }

    currentChallenge = challengeQueue.shift();
    challengeShownAt = Date.now();

    statusEl.innerText = "ðŸ§  Challenge: " + currentChallenge.instruction;
}

/* ------------------ START CAMERA ------------------ */
async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    video.srcObject = stream;

    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];

    mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
}

/* ------------------ RECORD & VERIFY ------------------ */
async function recordAndVerify() {
    mediaRecorder.start();

    setTimeout(async () => {
        mediaRecorder.stop();

        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, { type: "video/webm" });
            const formData = new FormData();

            formData.append("challenge_id", currentChallenge.challenge_id);
            formData.append("device_id", "web-client");
            formData.append("video", blob, "verification.webm");

            statusEl.innerText = "ðŸ” Verifying...";

            const res = await fetch("http://127.0.0.1:8000/v1/verify", {
                method: "POST",
                body: formData
            });

            const data = await res.json();

            if (!res.ok || !data.challenge_passed) {
                statusEl.innerText = "âŒ FAILED";
                return;
            }

            statusEl.innerText = "âœ… VERIFIED";

            if (challengeQueue.length > 0) {
                setTimeout(loadChallenge, 1500);
            }
        };
    }, 5000); // record 5 seconds
}

/* ------------------ BUTTON ------------------ */
startBtn.onclick = async () => {
    startBtn.disabled = true;
    await startCamera();
    await loadChallenge();
    await recordAndVerify();
};
</script>

</body>
</html>
