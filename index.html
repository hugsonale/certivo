<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certivo Prime Flow â€“ Trust Flow V1</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    text-align: center;
    padding: 20px;
}
video {
    width: 320px;
    border-radius: 12px;
    margin-top: 10px;
}
button {
    margin-top: 15px;
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}
#status {
    margin-top: 15px;
    font-weight: bold;
    min-height: 40px;
}
canvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
}
#verdict {
    display: none;
    margin-top: 25px;
}
#trustBarOuter {
    width: 320px;
    margin: 0 auto;
    background: #1e293b;
    border-radius: 12px;
    overflow: hidden;
}
#trustBar {
    height: 18px;
    width: 0%;
    transition: width 0.8s ease;
}
</style>
</head>

<body>

<h1>Certivo Prime Verification</h1>

<div style="position: relative; display: inline-block;">
    <video id="video" autoplay muted></video>
    <canvas id="overlay"></canvas>
</div>

<br>
<button id="startBtn">Start Verification</button>
<p id="status">Idle</p>

<div id="verdict">
    <h2 id="verdictTitle"></h2>
    <p>Trust Confidence</p>
    <div id="trustBarOuter">
        <div id="trustBar"></div>
    </div>
    <p id="trustLabel" style="margin-top:8px;font-weight:bold;"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh"></script>

<script>
let video = document.getElementById("video");
let overlay = document.getElementById("overlay");
let ctx = overlay.getContext("2d");
let statusEl = document.getElementById("status");
let startBtn = document.getElementById("startBtn");

let verdict = document.getElementById("verdict");
let verdictTitle = document.getElementById("verdictTitle");
let trustBar = document.getElementById("trustBar");
let trustLabel = document.getElementById("trustLabel");

let faceModel;
let mediaRecorder;
let chunks = [];
let canRecord = false;

/* CAMERA */
async function initCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    video.srcObject = stream;
    video.onloadeddata = () => {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
    };
}

/* FACE CHECK */
function startFaceCheck(){
    setInterval(async ()=>{
        const preds = await faceModel.estimateFaces(video);
        ctx.clearRect(0,0,overlay.width,overlay.height);

        if(preds.length !== 1){
            statusEl.innerText = "âš ï¸ Ensure one face is visible";
            canRecord = false;
            return;
        }

        canRecord = true;
        statusEl.innerText = "ðŸ§  Challenge: Briefly smile";

        const f = preds[0];
        const [x1,y1] = f.topLeft;
        const [x2,y2] = f.bottomRight;
        ctx.strokeStyle = "lime";
        ctx.lineWidth = 2;
        ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    },300);
}

/* RECORD */
function startRecording(){
    chunks = [];
    mediaRecorder = new MediaRecorder(video.srcObject);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = submit;
    mediaRecorder.start();
    setTimeout(()=>mediaRecorder.stop(), 3000);
}

/* SUBMIT */
async function submit(){
    statusEl.innerText = "ðŸ” Verifying...";
    const blob = new Blob(chunks,{type:"video/webm"});
    const fd = new FormData();
    fd.append("video", blob);
    fd.append("device_id","web");

    const res = await fetch("http://127.0.0.1:8000/v1/verify",{
        method:"POST",
        body: fd
    });

    const r = await res.json();
    showVerdict(r);
}

/* VERDICT */
function showVerdict(r){
    verdict.style.display = "block";

    if(!r.challenge_passed){
        verdictTitle.innerText = "âŒ VERIFICATION FAILED";
        verdictTitle.style.color = "#ef4444";
        trustBar.style.width = "0%";
        trustLabel.innerText = "Low Trust (0%)";
        return;
    }

    // âœ… FIXED: Correctly calculate trust percentage
    let score = parseFloat(r.liveness_score);
    if(score > 1) score = 1;       // cap at 1
    score = Math.round(score * 100);

    let level = "Low", color="#ef4444";
    if(score >= 90){ level="High"; color="#22c55e"; }
    else if(score >= 80){ level="Medium"; color="#facc15"; }

    verdictTitle.innerText = "âœ… HUMAN VERIFIED";
    verdictTitle.style.color = "#22c55e";
    trustBar.style.background = color;
    trustBar.style.width = score + "%";
    trustLabel.innerText = `${level} Trust (${score}%)`;
}

/* FLOW */
startBtn.onclick = async ()=>{
    startBtn.disabled = true;
    await initCamera();
    faceModel = await facemesh.load();
    startFaceCheck();

    const i = setInterval(()=>{
        if(canRecord){
            clearInterval(i);
            startRecording();
        }
    },300);
};
</script>

</body>
</html>
