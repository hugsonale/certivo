<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certivo Prime Verification</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    text-align: center;
    padding: 20px;
}

video {
    width: 320px;
    border-radius: 12px;
    margin-top: 10px;
}

button {
    margin-top: 15px;
    padding: 10px 22px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    background: #3b82f6;
    color: #fff;
}

button:disabled {
    background: #64748b;
    cursor: not-allowed;
}

#status, #faceStatus, #challengeProgress, #challengeTimer {
    margin-top: 15px;
    font-weight: bold;
    min-height: 24px;
}

#fastTrackLabel {
    display: none;
    color: #facc15;
    margin-top: 8px;
    font-weight: bold;
}

#verdictScreen {
    display: none;
    margin-top: 25px;
}

#trustBarOuter {
    width: 320px;
    margin: 0 auto;
    background: #1e293b;
    border-radius: 12px;
    overflow: hidden;
}

#trustBar {
    height: 18px;
    width: 0%;
    transition: width 0.8s ease;
}
</style>
</head>
<body>

<h1>Certivo Prime Verification</h1>

<!-- Camera & Face Verification -->
<div id="cameraContainer">
    <video id="video" autoplay muted></video>
</div>
<button id="startFaceBtn">Start Face Verification</button>

<div id="faceSection" style="display:none;">
    <p id="faceStatus">ðŸ“· Please show your face clearly</p>
    <button id="proceedBtn" disabled>Proceed to Challenge</button>
</div>

<!-- Challenges -->
<div id="challengeSection" style="display:none;">
    <p id="fastTrackLabel">âš¡ Fast-Track Mode</p>
    <p id="challengeProgress"></p>
    <p id="status"></p>
    <p id="challengeTimer"></p>
</div>

<!-- Verdict -->
<div id="verdictScreen">
    <h2>âœ… HUMAN VERIFIED</h2>
    <p>Trust Confidence</p>
    <div id="trustBarOuter"><div id="trustBar"></div></div>
    <p id="trustLabel" style="margin-top:10px;font-weight:bold;"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh"></script>

<script>
const startFaceBtn = document.getElementById("startFaceBtn");
const faceSection = document.getElementById("faceSection");
const challengeSection = document.getElementById("challengeSection");
const proceedBtn = document.getElementById("proceedBtn");
const video = document.getElementById("video");
const faceStatus = document.getElementById("faceStatus");
const statusEl = document.getElementById("status");
const challengeProgress = document.getElementById("challengeProgress");
const challengeTimer = document.getElementById("challengeTimer");
const fastTrackLabel = document.getElementById("fastTrackLabel");
const verdictScreen = document.getElementById("verdictScreen");
const trustBar = document.getElementById("trustBar");
const trustLabel = document.getElementById("trustLabel");

let faceModel, mediaRecorder;
let recordedChunks = [], recordingActive = false;
let challenges = [], challengeIndex = 0, sessionResults = [];
let countdownInterval = null;
let deviceId = "device_" + Math.floor(Math.random() * 100000);
let trustedDevice = false;

// ---------------- Camera & Face Verification ----------------
startFaceBtn.onclick = async () => {
    startFaceBtn.style.display = "none";
    faceSection.style.display = "block";
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    faceModel = await facemesh.load();
    startFaceVerification();
};

function startFaceVerification() {
    faceStatus.innerText = "ðŸ“· Looking for your face...";
    const interval = setInterval(async () => {
        const predictions = await faceModel.estimateFaces(video);
        if(predictions.length === 1){
            clearInterval(interval);
            faceStatus.innerText = "âœ… Face verified";
            proceedBtn.disabled = false;
        }
    }, 400);
}

// ---------------- Proceed to Challenge ----------------
proceedBtn.onclick = async () => {
    faceSection.style.display = "none";
    challengeSection.style.display = "block";
    statusEl.innerText = "â³ Loading challenges...";
    await loadChallenges();
};

// ---------------- Load Challenges ----------------
async function loadChallenges() {
    try {
        const res = await fetch(`http://127.0.0.1:8000/v1/challenge?device_id=${deviceId}`);
        const data = await res.json();
        trustedDevice = !!data.trusted_device;
        challenges = data.challenges.map(ch => ({...ch, fast_track: trustedDevice}));
        challengeIndex = 0;
        sessionResults = [];
        loadNextChallenge();
    } catch {
        statusEl.innerText = "âŒ Failed to load challenges";
    }
}

// ---------------- Challenge Flow ----------------
function loadNextChallenge() {
    clearInterval(countdownInterval);
    if(challengeIndex >= challenges.length){
        finalizeSession();
        return;
    }

    const ch = challenges[challengeIndex];
    challengeIndex++;

    challengeProgress.innerText = `Challenge ${challengeIndex} of ${challenges.length}`;
    statusEl.innerText = "ðŸ§  " + ch.instruction;
    fastTrackLabel.style.display = ch.fast_track ? "block" : "none";

    const duration = ch.fast_track ? 10 : 15;
    startRecording(ch.challenge_id, duration);
}

// ---------------- Recording & Countdown ----------------
function startRecording(challengeId, duration){
    recordedChunks = [];
    recordingActive = true;
    mediaRecorder = new MediaRecorder(video.srcObject);
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data) };
    mediaRecorder.onstop = async () => {
        if(!recordingActive) return;
        recordingActive = false;
        clearInterval(countdownInterval);
        countdownInterval = null;

        await submitRecording(challengeId);
    };
    mediaRecorder.start();
    setTimeout(()=>{if(mediaRecorder.state!=="inactive") mediaRecorder.stop()}, duration*1000);

    let t = duration;
    challengeTimer.innerText = `Time left: ${t}s`;
    countdownInterval = setInterval(()=>{
        t--;
        challengeTimer.innerText = `Time left: ${t}s`;
        if(t<=0){ clearInterval(countdownInterval); countdownInterval=null; }
    },1000);
}

// ---------------- Submit Recording ----------------
async function submitRecording(challengeId){
    const blob = new Blob(recordedChunks, {type:"video/webm"});
    const formData = new FormData();
    formData.append("video", blob);
    formData.append("challenge_id", challengeId);
    formData.append("device_id", deviceId);

    try {
        const res = await fetch("http://127.0.0.1:8000/v1/verify", {method:"POST", body:formData});
        const result = await res.json();
        sessionResults.push(result);
        statusEl.innerText = result.challenge_passed ? "âœ… Challenge passed" : "âŒ Challenge failed";
        setTimeout(loadNextChallenge, 600);
    } catch {
        statusEl.innerText = "âŒ Verification error";
        sessionResults.push({challenge_passed:false});
        setTimeout(loadNextChallenge, 800);
    }
}

// ---------------- Finalize Session ----------------
async function finalizeSession() {
    statusEl.innerText = "ðŸ” Calculating trust score...";
    challengeTimer.innerText = "";
    const res = await fetch("http://127.0.0.1:8000/v1/finalize", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({results: sessionResults, device_id: deviceId, user_agent: navigator.userAgent})
    });
    const final = await res.json();
    showVerdict(final.trust_score, final.trust_level);
}

function showVerdict(score, level){
    verdictScreen.style.display = "block";
    trustBar.style.width = score + "%";
    trustBar.style.background = level==="high" ? "#22c55e" : level==="medium" ? "#facc15" : "#ef4444";
    trustLabel.innerText = `${level.toUpperCase()} TRUST (${score}%)`;
}
</script>
</body>
</html>
